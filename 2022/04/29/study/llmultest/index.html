<!DOCTYPE html><html lang="zh-TW" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>long long 取模乘法的實驗 | LFsWang's World</title><meta name="author" content="LFsWang"><meta name="copyright" content="LFsWang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="在實作一些演算法，如 Miller-Rabin 時，會出現 long long 整數相乘再取餘數的步驟。 12long long a, b, c;auto res &#x3D; a * b % c; 然而若 a*b 的結果大於 long long 的表達範圍的話會溢位，便無法取得正確的結果。因此會需要自行實做乘法來避免溢位。具體方法可以參考維基百科，簡單來說就是模擬直式乘法：如果每次最多乘以 2，那麼一個">
<meta property="og:type" content="article">
<meta property="og:title" content="long long 取模乘法的實驗">
<meta property="og:url" content="https://lfswang.github.io/2022/04/29/study/llmultest/index.html">
<meta property="og:site_name" content="LFsWang&#39;s World">
<meta property="og:description" content="在實作一些演算法，如 Miller-Rabin 時，會出現 long long 整數相乘再取餘數的步驟。 12long long a, b, c;auto res &#x3D; a * b % c; 然而若 a*b 的結果大於 long long 的表達範圍的話會溢位，便無法取得正確的結果。因此會需要自行實做乘法來避免溢位。具體方法可以參考維基百科，簡單來說就是模擬直式乘法：如果每次最多乘以 2，那麼一個">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://lfswang.github.io/img/head-background.png">
<meta property="article:published_time" content="2022-04-28T17:52:54.000Z">
<meta property="article:modified_time" content="2023-03-18T07:45:14.059Z">
<meta property="article:author" content="LFsWang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lfswang.github.io/img/head-background.png"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="https://lfswang.github.io/2022/04/29/study/llmultest/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="kOB5iIggmllOLTY_QVBa4MDIIRs7f8LTu7B-pHaMWV8"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&amp;family=Noto+Sans+TC&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '複製成功',
    error: '複製錯誤',
    noSupport: '瀏覽器不支援'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '剛剛',
    min: '分鐘前',
    hour: '小時前',
    day: '天前',
    month: '個月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'long long 取模乘法的實驗',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-18 15:45:14'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">44</div></a><a href="/tags/"><div class="headline">標籤</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">分類</div><div class="length-num">13</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章列表</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情連結</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 關於我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/head-background.png')"><nav id="nav"><span id="blog-info"><a href="/" title="LFsWang's World"><span class="site-name">LFsWang's World</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章列表</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情連結</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 關於我</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">long long 取模乘法的實驗</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">發表於</span><time class="post-meta-date-created" datetime="2022-04-28T17:52:54.000Z" title="發表於 2022-04-29 01:52:54">2022-04-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新於</span><time class="post-meta-date-updated" datetime="2023-03-18T07:45:14.059Z" title="更新於 2023-03-18 15:45:14">2023-03-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Algorithm/">Algorithm</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字數總計:</span><span class="word-count">1.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">閱讀時長:</span><span>6分鐘</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="long long 取模乘法的實驗"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">閱讀量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>在實作一些演算法，如 Miller-Rabin 時，會出現 <code>long long</code> 整數相乘再取餘數的步驟。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="type">long</span> a, b, c;</span><br><span class="line"><span class="keyword">auto</span> res = a * b % c;</span><br></pre></td></tr></table></figure>
<p>然而若 <code>a*b</code> 的結果大於 <code>long long</code> 的表達範圍的話會溢位，便無法取得正確的結果。因此會需要自行實做乘法來避免溢位。具體方法可以參考<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%90%8C%E9%A4%98#.E7.AF.84.E4.BE.8B">維基百科</a>，簡單來說就是模擬直式乘法：如果每次<strong>最多乘以 2</strong>，那麼一個 63 bit 的整數可以在 64 bit 的空間內計算出來不會發生溢位。因此實作上用 <code>uint64_t</code> 來儲存即可。</p>
<p>不過絕大多數的 OJ 與競賽編譯器都使用 GCC，而 GCC 帶有非標準的 128 bit 整數 <code>__int128</code> <a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/_005f_005fint128.html">🔗</a>，如果環境允許使用的話，那麼就只需要把 <code>long long</code>轉型到<code>__int128</code>運算即可。</p>
<p>很久以前有人說<code>__int128</code>運算上很慢，因此似乎讓後者的實做不是特別的流行。既然最近剛好寫到了一題，就來做個實驗。</p>
<p>就直白說結論了：<code>__int128</code> 比自行用迴圈實作乘法快了 <code>30~50</code> 倍 (O3 優化)。</p>
<p>因此如果環境許可的話，就用 <code>__int128</code> ，程式碼既簡單又快速。具體的 <code>__int128</code> 組語要再來研究看看了。</p>
<table>
<thead>
<tr>
<th>方法</th>
<th><mjx-container class="MathJax" jax="SVG" style="direction: ltr; position: relative;"><svg style="overflow: visible; min-height: 1px; min-width: 1px; vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="3.25ex" height="2.02ex" role="img" focusable="false" viewBox="0 -871.1 1436.6 893.1" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" style="stroke-width: 3;"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)" style="stroke-width: 3;"/></g><g data-mml-node="mn" transform="translate(1033,393.1) scale(0.707)"><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" style="stroke-width: 3;"/></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline" style="top: 0px; left: 0px; clip: rect(1px, 1px, 1px, 1px); -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; position: absolute; padding: 1px 0px 0px 0px; border: 0px; display: block; width: auto; overflow: hidden;"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>10</mn><mn>7</mn></msup></math></mjx-assistive-mml></mjx-container> 次執行時間</th>
</tr>
</thead>
<tbody>
<tr>
<td>int128</td>
<td>48 ms</td>
</tr>
<tr>
<td>Morris 的實作 <a target="_blank" rel="noopener" href="https://morris821028.github.io/2015/07/11/uva-11476/">🔗</a></td>
<td>2066 ms</td>
</tr>
<tr>
<td>Wiki 的實作</td>
<td>1245 ms</td>
</tr>
</tbody>
</table>
<p>其實原本想拿<a target="_blank" rel="noopener" href="https://sunmoon-template.blogspot.com/2015/12/long-long-multiply-long-long-mod-long-long.html">日月卦長的實作</a>，不過該實作有上面提到實作細節的 bug ，而且跟 wiki 差不多，就沒放上了。</p>
<h2 id="實驗程式碼"><a class="headerlink" href="#實驗程式碼"></a>實驗程式碼</h2>
<ul>
<li>實驗環境
<ul>
<li>編譯器：gcc version 9.3.0 (Ubuntu 9.3.0-17ubuntu1~20.04)</li>
<li>編譯參數：g++ -O3</li>
<li>CPU: AMD-3700X</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> ll = <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> ll <span class="title">mul_int128</span><span class="params">(ll a, ll b, ll m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ll res = <span class="number">0</span>;</span><br><span class="line">    __int128 _a = a;</span><br><span class="line">    __int128 _b = b;</span><br><span class="line">    _a = (_a * _b) % m;</span><br><span class="line">    <span class="keyword">return</span> _a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">long</span> <span class="type">long</span> <span class="title">mul_morris</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> a, <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> b, <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> mod)</span> </span>&#123; </span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> ret = <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">for</span> (a %= mod, b %= mod; b != <span class="number">0</span>; b &gt;&gt;= <span class="number">1</span>, a &lt;&lt;= <span class="number">1</span>, a = a &gt;= mod ? a - mod : a) &#123;</span><br><span class="line">        <span class="keyword">if</span> (b&amp;<span class="number">1</span>) &#123;</span><br><span class="line">            ret += a;</span><br><span class="line">            <span class="keyword">if</span> (ret &gt;= mod)	ret -= mod;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> ret; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">mul_wiki</span><span class="params">(<span class="type">uint64_t</span> a, <span class="type">uint64_t</span> b, <span class="type">uint64_t</span> m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="type">uint64_t</span> d = <span class="number">0</span>, mp2 = m &gt;&gt; <span class="number">1</span>;</span><br><span class="line">   <span class="type">int</span> i;</span><br><span class="line">   <span class="keyword">if</span> (a &gt;= m) a %= m;</span><br><span class="line">   <span class="keyword">if</span> (b &gt;= m) b %= m;</span><br><span class="line">   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">64</span>; ++i)</span><br><span class="line">   &#123;</span><br><span class="line">       d = (d &gt; mp2) ? (d &lt;&lt; <span class="number">1</span>) - m : d &lt;&lt; <span class="number">1</span>;</span><br><span class="line">       <span class="keyword">if</span> (a &amp; <span class="number">0x8000000000000000</span>ULL)</span><br><span class="line">           d += b;</span><br><span class="line">       <span class="keyword">if</span> (d &gt; m) d -= m;</span><br><span class="line">       a &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> d%m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Test(Expr)                                                                            \</span></span><br><span class="line"><span class="meta">    []()                                                                                      \</span></span><br><span class="line"><span class="meta">    &#123;                                                                                         \</span></span><br><span class="line"><span class="meta">        std::mt19937_64 mt(7122);                                                             \</span></span><br><span class="line"><span class="meta">        ll hashv = 0;                                                                         \</span></span><br><span class="line"><span class="meta">        auto TimeStart = std::chrono::high_resolution_clock::now();                           \</span></span><br><span class="line"><span class="meta">        for (int i = 0; i &lt; 10; ++i)                                                          \</span></span><br><span class="line"><span class="meta">            for (int j = 0; j &lt; 1000000; ++j)                                                 \</span></span><br><span class="line"><span class="meta">            &#123;                                                                                 \</span></span><br><span class="line"><span class="meta">                ll a = mt() % LLONG_MAX;                                                      \</span></span><br><span class="line"><span class="meta">                ll b = mt() % LLONG_MAX;                                                      \</span></span><br><span class="line"><span class="meta">                ll c = 1 + mt() % (LLONG_MAX - 1);                                            \</span></span><br><span class="line"><span class="meta">                hashv ^= (Expr);                                                              \</span></span><br><span class="line"><span class="meta">            &#125;                                                                                 \</span></span><br><span class="line"><span class="meta">        auto TimeEnd = std::chrono::high_resolution_clock::now();                             \</span></span><br><span class="line"><span class="meta">        auto ms = std::chrono::duration_cast<span class="string">&lt;std::chrono::microseconds&gt;</span>(TimeEnd - TimeStart); \</span></span><br><span class="line"><span class="meta">        return std::make_tuple(ms.count(), hashv);                                            \</span></span><br><span class="line"><span class="meta">    &#125;();</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> Trys = <span class="number">10</span>;</span><br><span class="line">    <span class="type">const</span> ll EmptyHash = <span class="number">6862552923007731049LL</span>;</span><br><span class="line">    <span class="type">const</span> ll AcceptHash = <span class="number">8476752227605395455LL</span>;</span><br><span class="line">    ll TotalRunTime, RunTime;</span><br><span class="line">    ll HashVal = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ll EmptyRunTime = <span class="number">0</span>;</span><br><span class="line">    ll Int128RunTime = <span class="number">0</span>;</span><br><span class="line">    ll MorrisMulRunTime = <span class="number">0</span>;</span><br><span class="line">    ll WikiMulRunTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Test Empty loop...&quot;</span> &lt;&lt; endl;</span><br><span class="line">    TotalRunTime = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= Trys; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">tie</span>(RunTime, HashVal) = <span class="built_in">Test</span>(a^b^c);</span><br><span class="line">        TotalRunTime += RunTime;</span><br><span class="line">        cout &lt;&lt; <span class="built_in">setw</span>(<span class="number">2</span>) &lt;&lt; i &lt;&lt; <span class="string">&quot;. &quot;</span> &lt;&lt; RunTime &lt;&lt; <span class="string">&quot; microsecond&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">assert</span>(HashVal == EmptyHash);</span><br><span class="line">    &#125;</span><br><span class="line">    EmptyRunTime = TotalRunTime / Trys;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Test mul : __int128...&quot;</span> &lt;&lt; endl;</span><br><span class="line">    TotalRunTime = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= Trys; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">tie</span>(RunTime, HashVal) = <span class="built_in">Test</span>(<span class="built_in">mul_int128</span>(a,b,c));</span><br><span class="line">        TotalRunTime += RunTime;</span><br><span class="line">        cout &lt;&lt; <span class="built_in">setw</span>(<span class="number">2</span>) &lt;&lt; i &lt;&lt; <span class="string">&quot;. &quot;</span> &lt;&lt; RunTime &lt;&lt; <span class="string">&quot; microsecond&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">assert</span>(HashVal == AcceptHash);</span><br><span class="line">    &#125;</span><br><span class="line">    Int128RunTime = TotalRunTime / Trys - EmptyRunTime;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Test mul : morris&quot;</span> &lt;&lt; endl;</span><br><span class="line">    TotalRunTime = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= Trys; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">tie</span>(RunTime, HashVal) = <span class="built_in">Test</span>(<span class="built_in">mul_morris</span>(a,b,c));</span><br><span class="line">        TotalRunTime += RunTime;</span><br><span class="line">        cout &lt;&lt; <span class="built_in">setw</span>(<span class="number">2</span>) &lt;&lt; i &lt;&lt; <span class="string">&quot;. &quot;</span> &lt;&lt; RunTime &lt;&lt; <span class="string">&quot; microsecond&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">assert</span>(HashVal == AcceptHash);</span><br><span class="line">    &#125;</span><br><span class="line">    MorrisMulRunTime = TotalRunTime / Trys - EmptyRunTime;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Test mul : wiki&quot;</span> &lt;&lt; endl;</span><br><span class="line">    TotalRunTime = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= Trys; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">tie</span>(RunTime, HashVal) = <span class="built_in">Test</span>(<span class="built_in">mul_wiki</span>(a,b,c));</span><br><span class="line">        TotalRunTime += RunTime;</span><br><span class="line">        cout &lt;&lt; <span class="built_in">setw</span>(<span class="number">2</span>) &lt;&lt; i &lt;&lt; <span class="string">&quot;. &quot;</span> &lt;&lt; RunTime &lt;&lt; <span class="string">&quot; microsecond&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">assert</span>(HashVal == AcceptHash);</span><br><span class="line">    &#125;</span><br><span class="line">    WikiMulRunTime = TotalRunTime / Trys - EmptyRunTime;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;======================&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Empty : &quot;</span> &lt;&lt; EmptyRunTime &lt;&lt; <span class="string">&quot;\tmicrosecond&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;======================&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Int128: &quot;</span> &lt;&lt; Int128RunTime &lt;&lt; <span class="string">&quot;\tmicrosecond&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Morris: &quot;</span> &lt;&lt; MorrisMulRunTime &lt;&lt; <span class="string">&quot;\tmicrosecond&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Wiki  : &quot;</span> &lt;&lt; WikiMulRunTime &lt;&lt; <span class="string">&quot;\tmicrosecond&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;======================&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="程式輸出"><a class="headerlink" href="#程式輸出"></a>程式輸出</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">Test Empty loop...</span><br><span class="line"> 1. 204376 microsecond</span><br><span class="line"> 2. 195937 microsecond</span><br><span class="line"> 3. 198422 microsecond</span><br><span class="line"> 4. 193477 microsecond</span><br><span class="line"> 5. 196865 microsecond</span><br><span class="line"> 6. 199258 microsecond</span><br><span class="line"> 7. 196088 microsecond</span><br><span class="line"> 8. 203152 microsecond</span><br><span class="line"> 9. 194675 microsecond</span><br><span class="line">10. 193845 microsecond</span><br><span class="line">Test mul : __int128...</span><br><span class="line"> 1. 242874 microsecond</span><br><span class="line"> 2. 246191 microsecond</span><br><span class="line"> 3. 246739 microsecond</span><br><span class="line"> 4. 244880 microsecond</span><br><span class="line"> 5. 246286 microsecond</span><br><span class="line"> 6. 245972 microsecond</span><br><span class="line"> 7. 246628 microsecond</span><br><span class="line"> 8. 245438 microsecond</span><br><span class="line"> 9. 247223 microsecond</span><br><span class="line">10. 245661 microsecond</span><br><span class="line">Test mul : morris</span><br><span class="line"> 1. 2265340 microsecond</span><br><span class="line"> 2. 2271909 microsecond</span><br><span class="line"> 3. 2326091 microsecond</span><br><span class="line"> 4. 2247727 microsecond</span><br><span class="line"> 5. 2277070 microsecond</span><br><span class="line"> 6. 2240657 microsecond</span><br><span class="line"> 7. 2235139 microsecond</span><br><span class="line"> 8. 2277157 microsecond</span><br><span class="line"> 9. 2250817 microsecond</span><br><span class="line">10. 2247773 microsecond</span><br><span class="line">Test mul : wiki</span><br><span class="line"> 1. 1435613 microsecond</span><br><span class="line"> 2. 1434507 microsecond</span><br><span class="line"> 3. 1451556 microsecond</span><br><span class="line"> 4. 1440528 microsecond</span><br><span class="line"> 5. 1442246 microsecond</span><br><span class="line"> 6. 1439456 microsecond</span><br><span class="line"> 7. 1442855 microsecond</span><br><span class="line"> 8. 1469818 microsecond</span><br><span class="line"> 9. 1428127 microsecond</span><br><span class="line">10. 1445635 microsecond</span><br><span class="line">======================</span><br><span class="line">Empty : 197609	microsecond</span><br><span class="line">======================</span><br><span class="line">Int128: 48180	microsecond</span><br><span class="line">Morris: 2066359	microsecond</span><br><span class="line">Wiki  : 1245425	microsecond</span><br><span class="line">======================</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="反組譯參考"><a class="headerlink" href="#反組譯參考"></a>反組譯參考</h2>
<p>很明顯的 <code>__int128</code> 的輸出短很多，而且都是簡易運算指令。自行實作的乘法有 <code>jmp</code> 等跳轉，明顯複雜。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://godbolt.org/z/fa3Yvxa9q">godbolt</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://lfswang.github.io">LFsWang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章連結: </span><span class="post-copyright-info"><a href="https://lfswang.github.io/2022/04/29/study/llmultest/">https://lfswang.github.io/2022/04/29/study/llmultest/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版權聲明: </span><span class="post-copyright-info">本部落格所有文章除特別聲明外，均採用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 許可協議。轉載請註明來自 <a href="https://lfswang.github.io" target="_blank">LFsWang's World</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/head-background.png" data-sites="facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/05/21/ZJ/f498/" title="f498: Heap"><img class="cover" src="/img/head-background.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">f498: Heap</div></div></a></div><div class="next-post pull-right"><a href="/2018/10/02/tfcis-2018-10-02-contest/" title="2018 臺南一中上學期資訊學科能力競賽校內複選題解"><img class="cover" src="/img/head-background.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">2018 臺南一中上學期資訊學科能力競賽校內複選題解</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">LFsWang</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">44</div></a><a href="/tags/"><div class="headline">標籤</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">分類</div><div class="length-num">13</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/LFsWang/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/LFsWang" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://www.facebook.com/profile.php?id=100068564766766&amp;ref=bookmarks" target="_blank" title="Facebook"><i class="fab fa-facebook"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">更新主題中!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目錄</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%A6%E9%A9%97%E7%A8%8B%E5%BC%8F%E7%A2%BC"><span class="toc-number">1.</span> <span class="toc-text">實驗程式碼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BC%8F%E8%BC%B8%E5%87%BA"><span class="toc-number">2.</span> <span class="toc-text">程式輸出</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E7%B5%84%E8%AD%AF%E5%8F%83%E8%80%83"><span class="toc-number">3.</span> <span class="toc-text">反組譯參考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/09/09/Life/20230909-%E6%96%B0%E7%AB%B9%E9%A2%A8%E7%A9%BA%E8%80%81%E6%A8%9F%E6%A8%B9/" title="2023/09/09 20230909-新竹風空老樟樹"><img src="/2023/09/09/Life/20230909-%E6%96%B0%E7%AB%B9%E9%A2%A8%E7%A9%BA%E8%80%81%E6%A8%9F%E6%A8%B9/top.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2023/09/09 20230909-新竹風空老樟樹"/></a><div class="content"><a class="title" href="/2023/09/09/Life/20230909-%E6%96%B0%E7%AB%B9%E9%A2%A8%E7%A9%BA%E8%80%81%E6%A8%9F%E6%A8%B9/" title="2023/09/09 20230909-新竹風空老樟樹">2023/09/09 20230909-新竹風空老樟樹</a><time datetime="2023-09-09T10:59:13.000Z" title="發表於 2023-09-09 18:59:13">2023-09-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/16/Life/20230712-%E5%8C%97%E4%BA%AC/" title="2023/07/12-15 中國北京 兩岸清華交流賽"><img src="/2023/07/16/Life/20230712-%E5%8C%97%E4%BA%AC/top.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2023/07/12-15 中國北京 兩岸清華交流賽"/></a><div class="content"><a class="title" href="/2023/07/16/Life/20230712-%E5%8C%97%E4%BA%AC/" title="2023/07/12-15 中國北京 兩岸清華交流賽">2023/07/12-15 中國北京 兩岸清華交流賽</a><time datetime="2023-07-16T09:02:25.000Z" title="發表於 2023-07-16 17:02:25">2023-07-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/07/ACG/%E5%BF%83%E5%BE%97/LOOPERS/" title="LOOPERS"><img src="/2023/07/07/ACG/%E5%BF%83%E5%BE%97/LOOPERS/logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LOOPERS"/></a><div class="content"><a class="title" href="/2023/07/07/ACG/%E5%BF%83%E5%BE%97/LOOPERS/" title="LOOPERS">LOOPERS</a><time datetime="2023-07-07T08:38:13.000Z" title="發表於 2023-07-07 16:38:13">2023-07-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/01/ACG/%E5%BF%83%E5%BE%97/%E5%A5%B3%E8%A3%9D%E7%A5%9E%E8%A9%B1/" title="女裝神話"><img src="/img/head-background.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="女裝神話"/></a><div class="content"><a class="title" href="/2023/07/01/ACG/%E5%BF%83%E5%BE%97/%E5%A5%B3%E8%A3%9D%E7%A5%9E%E8%A9%B1/" title="女裝神話">女裝神話</a><time datetime="2023-06-30T16:38:12.000Z" title="發表於 2023-07-01 00:38:12">2023-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/01/ACG/%E5%BF%83%E5%BE%97/%E6%84%9B%E9%BA%97%E5%A9%AD%E7%9A%84%E6%98%8E%E6%97%A5%E7%9B%9B%E5%85%B8/" title="愛麗婭的明日盛典！ / 愛麗婭的明日盛典！Flowering Sky"><img src="/img/head-background.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="愛麗婭的明日盛典！ / 愛麗婭的明日盛典！Flowering Sky"/></a><div class="content"><a class="title" href="/2023/07/01/ACG/%E5%BF%83%E5%BE%97/%E6%84%9B%E9%BA%97%E5%A9%AD%E7%9A%84%E6%98%8E%E6%97%A5%E7%9B%9B%E5%85%B8/" title="愛麗婭的明日盛典！ / 愛麗婭的明日盛典！Flowering Sky">愛麗婭的明日盛典！ / 愛麗婭的明日盛典！Flowering Sky</a><time datetime="2023-06-30T16:38:12.000Z" title="發表於 2023-07-01 00:38:12">2023-07-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2023 By LFsWang</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="閱讀模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="淺色和深色模式轉換"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="單欄和雙欄切換"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="設定"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目錄"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到頂部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>